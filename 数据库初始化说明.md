# 数据库集合初始化说明

## 概述
由于意外删除了数据库集合，我已经为您创建了一个专门的云函数 `initDatabase` 来重新创建和初始化所有必要的集合。

## 需要创建的集合

### 1. users 集合（用户信息）
- `phone`: 手机号（登录用）
- `password`: 加密密码
- `nickName`: 用户昵称
- `role`: 用户角色（admin/viewer）
- `avatarUrl`: 头像URL
- `openid`: 微信openid
- `createTime`: 创建时间
- `lastLoginTime`: 最后登录时间

### 2. grades 集合（年级信息）
- `name`: 年级名称（一年级-六年级）
- `order`: 排序字段
- `createTime`: 创建时间
- `updateTime`: 更新时间

### 3. classes 集合（班级信息）
- `name`: 班级名称（1班-4班）
- `gradeId`: 关联年级ID
- `order`: 排序字段
- `status`: 班级状态（0=未放学，1=已放学）
- `createTime`: 创建时间
- `updateTime`: 更新时间

## 使用步骤

### 第一步：部署云函数
1. 在微信开发者工具中，右键点击 `cloudfunctions/initDatabase` 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成

### 第二步：执行初始化
在小程序中调用云函数来初始化数据库：

#### 方法1：检查集合状态
```javascript
wx.cloud.callFunction({
  name: 'initDatabase',
  data: {
    action: 'checkCollections'
  }
}).then(res => {
  console.log('集合状态:', res.result)
})
```

#### 方法2：一键初始化所有集合
```javascript
wx.cloud.callFunction({
  name: 'initDatabase',
  data: {
    action: 'initAll'
  }
}).then(res => {
  console.log('初始化结果:', res.result)
  if (res.result.success) {
    console.log('数据库初始化完成！')
  }
})
```

#### 方法3：分步初始化
```javascript
// 只初始化年级
wx.cloud.callFunction({
  name: 'initDatabase',
  data: { action: 'initGrades' }
})

// 只初始化班级
wx.cloud.callFunction({
  name: 'initDatabase',
  data: { action: 'initClasses' }
})

// 只初始化用户
wx.cloud.callFunction({
  name: 'initDatabase',
  data: { action: 'initUsers' }
})
```

## 默认数据

### 年级数据
- 一年级到六年级，每个年级包含4个班级（1班-4班）

### 用户数据
系统会创建两个默认用户：

1. **管理员账户**
   - 手机号：13800138000
   - 密码：123456
   - 角色：admin

2. **测试用户**
   - 手机号：13800138001
   - 密码：123456
   - 角色：viewer

## 注意事项

1. **安全提醒**：初始化完成后，请立即修改默认用户的密码
2. **重复执行**：云函数会检查数据是否已存在，避免重复创建
3. **依赖关系**：班级数据依赖年级数据，建议按顺序初始化
4. **权限设置**：确保云函数有数据库读写权限

## 验证初始化结果

初始化完成后，可以在云开发控制台的数据库页面查看：
- users 集合：应该有2条用户记录
- grades 集合：应该有6条年级记录
- classes 集合：应该有24条班级记录（6个年级 × 4个班级）

## 故障排除

如果初始化失败，请检查：
1. 云函数是否正确部署
2. 云开发环境是否正确配置
3. 数据库权限是否正确设置
4. 查看云函数日志获取详细错误信息