# 学校放学管理系统 - 管理功能说明

## 📋 功能总览

您的小程序现在包含以下完整的管理功能：

### 🏠 主要页面
- **首页** (`/pages/index/index`) - 班级状态显示和切换
- **登录页** (`/pages/login/login`) - 用户登录
- **用户页** (`/pages/user/user`) - 个人信息管理

### 🔧 管理功能

#### 1. **管理中心** (`/pages/admin/admin`)
- 管理员主页，包含所有管理功能的入口
- 显示当前用户信息和权限
- 提供班级管理、用户管理、系统工具的快速访问

#### 2. **班级管理** (`/pages/admin/classes/classes`)
- ✅ 查看所有年级和班级
- ✅ 添加新班级
- ✅ 编辑班级信息
- ✅ 删除班级
- ✅ 批量操作班级状态

#### 3. **用户管理** (`/pages/admin/users/users`)
- ✅ 查看所有用户列表
- ✅ 添加新用户
- ✅ 修改用户权限
- ✅ 删除用户
- ✅ 用户角色管理

#### 4. **系统工具**

##### 数据库初始化 (`/pages/admin/database-init`)
- 🔧 检查数据库集合状态
- 🔧 一键初始化所有集合
- 🔧 分步初始化各个集合
- 🔧 创建默认数据

##### 班级状态调试 (`/pages/admin/class-status-debug`)
- 🔍 实时查看班级状态
- 🔍 测试状态切换功能
- 🔍 查看操作日志
- 🔍 排查状态更新问题

##### 权限修复工具 (`/pages/admin/fix-permissions`)
- 🛠️ 诊断用户权限问题
- 🛠️ 自动修复 OpenID 匹配
- 🛠️ 重新同步用户权限
- 🛠️ 测试权限验证

## 🚀 使用流程

### 初次使用
1. **部署云函数**：确保所有云函数已正确部署
2. **初始化数据库**：访问数据库初始化页面，创建基础数据
3. **创建管理员**：使用默认账号登录或创建新管理员
4. **配置班级**：在班级管理页面添加实际的年级和班级

### 日常管理
1. **班级状态管理**：在首页点击班级名称切换放学状态
2. **用户权限管理**：在用户管理页面添加/修改用户权限
3. **数据维护**：使用系统工具进行数据库维护和问题排查

## 📊 数据结构

### users 集合
```javascript
{
  _id: "用户ID",
  phone: "手机号",
  password: "加密密码",
  nickName: "用户昵称",
  role: "admin|viewer", // 用户角色
  openid: "微信OpenID",
  createTime: "创建时间",
  lastLoginTime: "最后登录时间"
}
```

### grades 集合
```javascript
{
  _id: "年级ID",
  name: "年级名称", // 如：一年级
  order: 1, // 排序
  createTime: "创建时间",
  updateTime: "更新时间"
}
```

### classes 集合
```javascript
{
  _id: "班级ID",
  name: "班级名称", // 如：1班
  gradeId: "年级ID",
  order: 1, // 排序
  status: 0, // 0=未放学, 1=已放学
  createTime: "创建时间",
  updateTime: "更新时间"
}
```

## 🔐 权限说明

### 角色权限
- **admin**：完全管理权限，可以管理用户、班级、系统设置
- **viewer**：只读权限，可以查看班级状态，但不能修改

### 功能权限
- **班级状态切换**：需要 admin 或 viewer 权限
- **用户管理**：仅 admin 权限
- **班级管理**：仅 admin 权限
- **系统工具**：仅 admin 权限

## 🛠️ 故障排除

### 常见问题
1. **无法切换班级状态**
   - 检查用户权限
   - 使用权限修复工具
   - 查看班级状态调试页面

2. **登录失败**
   - 检查手机号和密码
   - 确认用户已创建
   - 查看云函数日志

3. **数据显示异常**
   - 使用数据库初始化工具检查
   - 重新初始化数据
   - 检查云函数部署状态

### 调试工具
- 使用浏览器开发者工具查看控制台日志
- 访问各个调试页面查看详细信息
- 检查云函数日志了解后端执行情况

## 📞 技术支持

如果遇到问题，请：
1. 先使用系统内置的调试工具
2. 查看控制台日志和错误信息
3. 检查云函数部署和权限设置
4. 参考本文档的故障排除部分