# 学校放学管理小程序 - 部署说明

## 系统概述

本系统已完成重大更新，实现了基于手机号验证的权限管理系统：

### 主要功能
1. **统一登录入口** - 所有用户必须先进入登录页面
2. **手机号验证** - 通过微信获取手机号并验证权限
3. **权限分级** - 管理员可操作班级状态，普通用户只能查看
4. **管理员后台** - 管理授权手机号列表

### 用户角色
- **管理员(admin)** - 可以修改班级状态，管理授权手机号
- **访客(viewer)** - 只能查看班级放学状态

## 部署步骤

### 1. 云函数部署

需要部署以下云函数，**重要：部署时必须选择"云端安装依赖"**：

#### phoneVerify 云函数
```bash
# 进入云函数目录
cd cloudfunctions/phoneVerify

# 确保 package.json 存在
# 在微信开发者工具中右键该云函数文件夹
# 选择"上传并部署：云端安装依赖"
```

#### 其他现有云函数
- `getClassesStatus` - 获取班级状态
- `updateClassStatus` - 更新班级状态  
- `resetClassesStatus` - 重置所有班级状态
- `getGradesAndClasses` - 获取年级班级数据

### 2. 数据库初始化

在云开发控制台创建以下集合：

#### admin_phones 集合
用于存储授权的管理员手机号：
```json
{
  "_id": "自动生成",
  "phone": "13800138000",
  "role": "admin",
  "status": "active",
  "createTime": "2024-01-01T00:00:00.000Z",
  "updateTime": "2024-01-01T00:00:00.000Z"
}
```

**初始管理员添加方法：**
1. 在云开发控制台手动添加第一个管理员手机号
2. 或通过数据库导入功能批量添加

### 3. 小程序配置

#### app.json 配置
- 登录页面已设为首页
- tabBar 配置完整

#### 权限配置
在 `app.json` 中确保包含获取手机号权限：
```json
{
  "permission": {
    "scope.userInfo": {
      "desc": "用于完善用户资料"
    }
  }
}
```

### 4. 测试流程

#### 管理员测试
1. 在数据库中添加测试手机号
2. 使用该手机号登录小程序
3. 验证管理功能是否正常

#### 普通用户测试  
1. 使用未授权手机号登录
2. 确认只能查看不能操作

## 使用说明

### 管理员操作
1. **添加授权手机号**
   - 进入管理中心
   - 点击"添加"按钮
   - 输入要授权的手机号

2. **删除授权手机号**
   - 在手机号列表中点击"删除"
   - 确认删除操作

3. **重置班级状态**
   - 在管理中心点击"重置所有班级状态"
   - 所有班级将设为未放学状态

### 普通用户操作
1. **查看班级状态**
   - 登录后可查看所有班级放学状态
   - 实时更新显示

2. **尝试操作提示**
   - 点击班级状态时会提示无权限

## 注意事项

### 安全考虑
1. **手机号验证** - 只有预先添加的手机号才能获得管理权限
2. **权限隔离** - 严格区分管理员和访客权限
3. **数据保护** - 敏感操作需要二次确认

### 维护建议
1. **定期备份** - 备份授权手机号数据
2. **权限审查** - 定期检查授权手机号列表
3. **日志监控** - 关注云函数调用日志

### 常见问题

#### 1. 云函数部署失败
- 确保选择"云端安装依赖"
- 检查 package.json 文件是否正确
- 查看云函数日志排查错误

#### 2. 手机号验证失败
- 检查数据库中是否存在该手机号
- 确认手机号状态为 "active"
- 查看云函数调用日志

#### 3. 权限异常
- 重新登录刷新权限状态
- 检查用户角色设置
- 确认授权手机号配置正确

#### 4. 图标文件缺失
- 如果提示 admin.png 或 admin_selected.png 不存在
- 已自动复制 user.png 作为 admin.png
- 可以后续替换为自定义的管理员图标

## 技术支持

如遇到问题，请检查：
1. 云函数部署状态
2. 数据库集合和数据
3. 小程序权限配置
4. 云开发环境设置

系统现已完成基于手机号验证的权限管理改造，提供了更安全和便捷的管理方式。